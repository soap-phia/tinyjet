<body>
  <form id="search"><input id="url" type="text" class="search-input search" placeholder="Search the web or enter URL"></form>
  <form id="wisp"><input id="websocket" type="text" class="search-input search" value="wss://gointospace.app/wisp/"></form>
  <iframe id="iframe" width="100%" height="100%"></iframe>
  <script src="https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js" defer></script>
  <script type="module" defer>
    import * as BareMux from "https://cdn.jsdelivr.net/npm/@mercuryworkshop/bare-mux/dist/index.mjs";
    const { ScramjetController } = $scramjetLoadController();
    const scramjet = new ScramjetController({ 
      files: { 
        wasm: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/wasm.wasm", 
        all: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.all.js", 
        sync: "https://cdn.jsdelivr.net/gh/soap-phia/tinyjet@latest/tinyjet/scramjet.sync.js" 
      } 
    });
    try {
      scramjet.init();
      navigator.serviceWorker.register("/sw.js");
    } catch (e) { console.error("scramjet failed to initialize;", e); }
    const connection = new BareMux.BareMuxConnection("/bareworker.js");
    document.getElementById("websocket").placeholder = "wss://gointospace.app/wisp/";
    function getWispUrl() {
        const wisp = document.getElementById("websocket").value.trim();
        const defaultWisp = "wss://gointospace.app/wisp/";
        return wisp || defaultWisp;
    }
    async function setTransport(transportsel) {
      const wispUrl = getWispUrl();
      switch (transportsel) {
        case "epoxy":
          await connection.setTransport("https://cdn.jsdelivr.net/npm/@mercuryworkshop/epoxy-transport/dist/index.mjs", [{ wisp: wispUrl }]);
          break;
        case "libcurl":
          await connection.setTransport("https://cdn.jsdelivr.net/npm/@mercuryworkshop/libcurl-transport/dist/index.mjs", [{ websocket: wispUrl }]);
          break;
        default:
          await connection.setTransport("https://cdn.jsdelivr.net/npm/@mercuryworkshop/epoxy-transport/dist/index.mjs", [{ wisp: wispUrl }]);
          break;
      }
    }
    document.getElementById("wisp").addEventListener("submit", async (event) => {
        event.preventDefault();
        await setTransport("epoxy");
    });
    function search(input) {
      let template = "https://search.brave.com/search?q=%s";

      try {
        return new URL(input).toString();
      } catch (err) {}

      try {
        let url = new URL(`http://${input}`);
        if (url.hostname.includes(".")) return url.toString();
      } catch (err) {}

      return template.replace("%s", input); 
    }

    setTransport("epoxy");
    document.getElementById("search").addEventListener("submit", async (event) => {
      event.preventDefault();
      let fixedurl = search(document.getElementById("url").value);
      let src;
      src = scramjet.encodeUrl(fixedurl);
      document.getElementById("iframe").src = src;
    });
  </script>
</body>